<aside
  class="medical-sidebar"
  [class.collapsed]="(uiStateService.isSidebarCollapsed$ | async)"
  [style.width]="(uiStateService.isSidebarCollapsed$ | async) ? '80px' : '450px'">

  <!-- Header -->
  <div class="sidebar-header">
    <h2 *ngIf="!(uiStateService.isSidebarCollapsed$ | async)" class="sidebar-title">
      🩺 Pacientes TecSalud
    </h2>
    <button
      (click)="toggleSidebar()"
      class="toggle-button"
      [title]="(uiStateService.isSidebarCollapsed$ | async) ? 'Expandir panel de pacientes' : 'Contraer panel de pacientes'"
      [attr.aria-label]="(uiStateService.isSidebarCollapsed$ | async) ? 'Expandir panel de pacientes' : 'Contraer panel de pacientes'">
      <svg *ngIf="!(uiStateService.isSidebarCollapsed$ | async)" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M15 18l-6-6 6-6"/>
      </svg>
      <svg *ngIf="(uiStateService.isSidebarCollapsed$ | async)" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M9 18l6-6-6-6"/>
      </svg>
    </button>
  </div>

  <!-- Search Section -->
  <div class="search-section" *ngIf="!(uiStateService.isSidebarCollapsed$ | async)">
    <input
      type="text"
      placeholder="Buscar paciente..."
      class="search-input"
      (input)="onSearchInputChange($any($event.target).value)"
      [disabled]="isSearching">
    <div *ngIf="isSearching" class="search-loading">Buscando...</div>
  </div>

  <!-- Collapsed Search Icon -->
  <div class="collapsed-search" *ngIf="(uiStateService.isSidebarCollapsed$ | async)">
    <button
      (click)="toggleSidebar()"
      class="search-icon-button"
      title="Buscar pacientes">
      🔍
    </button>
  </div>

  <!-- Navigation Section -->
  <div class="nav-container" *ngIf="!(uiStateService.isSidebarCollapsed$ | async)">
    <bmb-card class="nav-card-wrapper" type="normal">
      <a routerLink="/chat" routerLinkActive="active" class="nav-link">
        <span class="nav-icon">🩺</span>
        <span class="nav-text">Copiloto Médico</span>
      </a>
    </bmb-card>

    <bmb-card class="nav-card-wrapper" type="normal">
      <a routerLink="/documents" class="nav-link">
        <span class="nav-icon">📤</span>
        <span class="nav-text">Subir Expedientes</span>
      </a>
    </bmb-card>

    <bmb-card class="nav-card-wrapper" type="normal">
      <a routerLink="/documents" class="nav-link">
        <span class="nav-icon">📚</span>
        <span class="nav-text">Ver Documentos</span>
      </a>
    </bmb-card>

    <bmb-card class="nav-card-wrapper" type="normal">
      <a routerLink="/dashboard" routerLinkActive="active" class="nav-link">
        <span class="nav-icon">📊</span>
        <span class="nav-text">Dashboard</span>
      </a>
    </bmb-card>
  </div>

  <!-- Patients List -->
  <div class="patients-container">
    <div *ngIf="!(uiStateService.isSidebarCollapsed$ | async)">

      <!-- Search Results Section -->
      <div *ngIf="searchResults.length > 0" class="search-results-section">
        <h3 class="section-title">
          🔍 Resultados de Búsqueda ({{searchResults.length}})
        </h3>

        <div class="patients-list">
          <bmb-card
            *ngFor="let patient of searchResults; trackBy: trackByPatientId"
            [class]="getPatientCardClasses(patient)"
            (click)="selectSearchResult(patient)"
            class="patient-card-wrapper patient-card-bamboo search-result-card"
            type="normal">

            <div class="patient-content">
              <!-- Avatar -->
              <div class="patient-avatar">
                {{ getPatientInitials(patient) }}
              </div>

              <!-- Patient Info -->
              <div class="patient-info">
                <div class="patient-name">{{ patient.name || patient.nombre_paciente || 'Nombre no disponible' }}</div>
                <div class="patient-meta">{{ patient.age || 'N/A' }} años • {{ patient.gender === 'M' ? 'Masculino' : patient.gender === 'F' ? 'Femenino' : 'N/A' }}</div>
                <div class="patient-score" *ngIf="patient.similarity_score">
                  Coincidencia: {{(patient.similarity_score * 100) | number:'1.0-0'}}%
                </div>
              </div>
            </div>
          </bmb-card>

          <!-- Empty Search State -->
          <div *ngIf="searchResults.length === 0 && isSearching" class="empty-state">
            <div class="empty-icon">🔍</div>
            <p>Buscando pacientes...</p>
            <small>Espera un momento</small>
          </div>
        </div>
      </div>

      <!-- Recent Patients Section (shown when no search results) -->
      <div *ngIf="searchResults.length === 0" class="recent-patients-section">
        <h3 class="section-title">
          ❤️ Pacientes Recientes ({{recentPatients.length}})
        </h3>

        <div class="patients-list">
          <bmb-card
            *ngFor="let patient of recentPatients; trackBy: trackByPatientId"
            [class]="getPatientCardClasses(patient)"
            (click)="selectPatient(patient)"
            class="patient-card-wrapper patient-card-bamboo"
            type="normal">

            <div class="patient-content">
              <!-- Avatar -->
              <div class="patient-avatar">
                {{ getPatientInitials(patient) }}
              </div>

              <!-- Patient Info -->
              <div class="patient-info">
                <div class="patient-name">{{ patient.name || patient.nombre_paciente || 'Nombre no disponible' }}</div>
                <div class="patient-meta">{{ patient.age || 'N/A' }} años • {{ patient.gender === 'M' ? 'Masculino' : patient.gender === 'F' ? 'Femenino' : 'N/A' }}</div>
              </div>
            </div>
          </bmb-card>

          <!-- Empty State -->
          <div *ngIf="recentPatients.length === 0" class="empty-state">
            <div class="empty-icon">👤</div>
            <p>No hay pacientes recientes</p>
            <small>Busca un paciente para comenzar</small>
          </div>
        </div>
      </div>
    </div>

    <!-- Collapsed Icons -->
    <div *ngIf="(uiStateService.isSidebarCollapsed$ | async)" class="collapsed-patients">
      <div
        *ngFor="let patient of recentPatients.slice(0, 5); trackBy: trackByPatientId"
        class="collapsed-patient-item">
        <button
          (click)="selectPatient(patient)"
          [class]="getCollapsedPatientClasses(patient)"
          class="collapsed-patient-button"
          [attr.title]="patient.name">
          {{ getPatientInitials(patient) }}
        </button>
      </div>

      <!-- Collapsed medical icon indicator -->
      <div class="collapsed-medical-indicator">
        ❤️
      </div>
    </div>
  </div>
</aside>
